const u=a=>a.toDataURL("image/png",1),x=a=>typeof a=="function",h=a=>a===void 0,g=(a,e={},t="http://www.w3.org/2000/svg")=>{const i=document.createElementNS(t,a);for(const s in e)i.setAttribute(s,e[s]);return i},w=(a,e,t)=>{const i=[];let s="";for(let o=0,n=e.length;o<n;o++)s+=e.charAt(o),a.measureText(s).width>t&&(i.push(s.substring(0,s.length-1)),s="",o--);return i.push(s),i},b=(a,e)=>{const t=g("svg",{xmlns:"http://www.w3.org/2000/svg"}),i=document.createElement("div");i.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),i.style.cssText=`
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  font: ${a.font};
  color: ${e.fontColor};
`,i.innerHTML=`<div class="rich-text-content">${e.content}</div>`,document.body.appendChild(i);const{offsetHeight:s,offsetWidth:o}=i.querySelector(".rich-text-content");document.body.removeChild(i);const n=e.richTextWidth||o||e.width,r=e.richTextHeight||s||e.height,c=g("foreignObject",{width:n.toString(),height:r.toString()});return c.appendChild(i),t.appendChild(c),{element:t,width:n,height:r}},f=a=>`data:image/svg+xml;charset=utf-8,${a.outerHTML.replace(/\n/g,"").replace(/\t/g,"").replace(/#/g,"%23")}`;class m{constructor(e={}){this.parentElement=document.body,this.props=e,this.options=Object.assign({width:300,height:300,rotate:45,translatePlacement:"middle",contentType:"text",content:"hello watermark-js-plus",imageWidth:0,imageHeight:0,lineHeight:30,zIndex:1e4,backgroundPosition:"0 0, 0 0",backgroundRepeat:"repeat",fontSize:20,fontFamily:"sans-serif",fontColor:"#000",globalAlpha:.5,fontWeight:"normal",mode:"default",mutationObserve:!0,unique:!0,parent:"body",onSuccess:()=>{},onBeforeDestroy:()=>{},onDestroyed:()=>{}},e),this.changeParentElement(this.options.parent),this.initializeOptions()}static createCanvas(e,t){var o;const i=window.devicePixelRatio||1,s=document.createElement("canvas");return s.width=e*i,s.height=t*i,s.style.width=`${e}px`,s.style.height=`${t}px`,(o=s.getContext("2d"))==null||o.setTransform(i,0,0,i,0,0),s}changeParentElement(e){if(typeof e=="string"){const t=document.querySelector(e);t&&(this.parentElement=t)}else this.parentElement=e}async create(){var o,n;if(!this.validateUnique()||!this.validateContent())return;const e=await this.draw(),t=u(e);this.watermarkDom=document.createElement("div");const i=document.createElement("div");this.watermarkDom.__WATERMARK__="watermark",this.watermarkDom.__WATERMARK__INSTANCE__=this;const s=this.checkParentElementType();this.watermarkDom.style.cssText=`
      z-index: ${this.options.zIndex};
      ${s==="custom"?"top: 0;bottom: 0;left: 0;right: 0;height: 100%;pointer-events: none;position: absolute":"position: relative"}
    `,i.style.cssText=`
      position: ${s==="root"?"fixed;":"absolute;"}
      z-index: ${this.options.zIndex};
      pointer-events: none;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background-image: url(${t});
      background-repeat: ${this.options.backgroundRepeat};
      background-size: ${this.options.width}px ${this.options.height}px;
      background-position: ${this.options.backgroundPosition};
      -webkit-print-color-adjust: exact;
    `,this.watermarkDom.append(i),this.parentElement.appendChild(this.watermarkDom),this.options.mutationObserve&&this.bindMutationObserve(),(n=(o=this.options).onSuccess)==null||n.call(o)}destroy(){var e,t,i,s,o,n,r;(t=(e=this.options).onBeforeDestroy)==null||t.call(e),(i=this.observer)==null||i.disconnect(),(s=this.parentObserve)==null||s.disconnect(),(o=this.watermarkDom)==null||o.remove(),(r=(n=this.options).onDestroyed)==null||r.call(n)}initializeOptions(){var o,n,r,c,l,p,d;(o=this.options)!=null&&o.rotate&&(this.options.rotate=(360-this.options.rotate%360)*(Math.PI/180));let e,t,i="middle",s="center";switch(this.options.translatePlacement){case"top":e=this.options.width/2,t=0,i="top";break;case"top-start":e=0,t=0,i="top",s="start";break;case"top-end":e=this.options.width,t=0,i="top",s="end";break;case"bottom":e=this.options.width/2,t=this.options.height,i="bottom";break;case"bottom-start":e=0,t=this.options.height,i="bottom",s="start";break;case"bottom-end":e=this.options.width,t=this.options.height,i="bottom",s="end";break;case"left":e=0,t=this.options.height/2,s="start";break;case"right":e=this.options.width,t=this.options.height/2,s="end";break;case"middle":e=this.options.width/2,t=this.options.height/2;break}(!h((n=this.props)==null?void 0:n.translateX)||!h((r=this.props)==null?void 0:r.translateY))&&(i="top",s="left"),h((c=this.props)==null?void 0:c.translateX)&&(this.options.translateX=e),h((l=this.props)==null?void 0:l.translateY)&&(this.options.translateY=t),h((p=this.props)==null?void 0:p.textBaseline)&&(this.options.textBaseline=i),h((d=this.props)==null?void 0:d.textAlign)&&(this.options.textAlign=s)}validateUnique(){let e=!0;return this.options.unique&&this.parentElement.childNodes.forEach(t=>{!e||Object.hasOwnProperty.call(t,"__WATERMARK__")&&(e=!1)}),e}validateContent(){switch(this.options.contentType){case"image":return Object.hasOwnProperty.call(this.options,"image");case"multi-line-text":case"rich-text":case"text":return this.options.content.length>0}return!1}draw(){const t=m.createCanvas(this.options.width,this.options.height).getContext("2d");if(t===null)throw new Error("get context error");return t.font=`${this.options.fontWeight} ${this.options.fontSize}px ${this.options.fontFamily}`,this.options.textAlign&&(t.textAlign=this.options.textAlign),this.options.textBaseline&&(t.textBaseline=this.options.textBaseline),t.fillStyle=this.options.fontColor,t.globalAlpha=this.options.globalAlpha,t.translate(this.options.translateX,this.options.translateY),t.rotate(this.options.rotate),new Promise(i=>{switch(this.options.contentType){case"text":this.drawText(t,i);break;case"image":this.drawImage(t,i);break;case"multi-line-text":this.drawMultiLineText(t,i);break;case"rich-text":this.drawRichText(t,i);break}})}drawText(e,t){e.fillText(this.options.content,0,0),t(e.canvas)}drawImage(e,t){const i=new Image;i.setAttribute("crossOrigin","Anonymous"),i.src=this.options.image,i.onload=()=>{const{width:s,height:o}=this.getImageRect(i),n=this.getDrawImagePosition(s,o);e.drawImage(i,n.x,n.y,s,o),t(e.canvas)}}drawMultiLineText(e,t){const i=w(e,this.options.content,this.options.width);let s;switch(this.options.textBaseline){case"middle":s=(i.length-1)*this.options.lineHeight/2;break;case"bottom":case"alphabetic":case"ideographic":s=(i.length-1)*this.options.lineHeight;break;case"top":case"hanging":s=0;break}i.forEach((o,n)=>{e.fillText(o,0,this.options.lineHeight*n-s)}),t(e.canvas)}drawRichText(e,t){const i=b(e,this.options),s=new Image;s.width=i.width,s.height=i.height,s.src=f(i.element),s.onload=()=>{const o=this.getDrawImagePosition(s.width,s.height);e.drawImage(s,o.x,o.y,e.canvas.width,e.canvas.height),t(e.canvas)}}getImageRect(e){const t={width:this.options.imageWidth,height:this.options.imageHeight};switch(!0){case(t.width!==0&&t.height===0):t.height=t.width*e.height/e.width;break;case(t.width===0&&t.height!==0):t.width=t.height*e.width/e.height;break;case(t.width===0&&t.height===0):t.width=e.width,t.height=e.height;break}return t}getDrawImagePosition(e,t){var s,o;const i={x:-e/2,y:-t/2};switch(this.options.translatePlacement){case"top":i.x=-e/2,i.y=0;break;case"top-start":i.x=0,i.y=0;break;case"top-end":i.x=-e,i.y=0;break;case"bottom":i.x=-e/2,i.y=-t;break;case"bottom-start":i.x=0,i.y=-t;break;case"bottom-end":i.x=-e,i.y=-t;break;case"left":i.x=0,i.y=-t/2;break;case"right":i.x=-e,i.y=-t/2;break}return!h((s=this.props)==null?void 0:s.translateX)&&(i.x=0),!h((o=this.props)==null?void 0:o.translateY)&&(i.y=0),i}checkParentElementType(){return["html","body"].includes(this.parentElement.tagName.toLocaleLowerCase())?"root":"custom"}bindMutationObserve(){!this.watermarkDom||(this.observer=new MutationObserver(e=>{e.length>0&&(this.destroy(),this.create())}),this.observer.observe(this.watermarkDom,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.parentObserve=new MutationObserver(e=>{e.forEach(t=>{var i;((t==null?void 0:t.target)===this.watermarkDom||((i=t==null?void 0:t.removedNodes)==null?void 0:i[0])===this.watermarkDom)&&(this.destroy(),this.create())})}),this.parentObserve.observe(this.parentElement,{attributes:!0,childList:!0,subtree:!0,characterData:!0}))}}export{m as W,u as c,x as i};
