const D=h=>h.toDataURL("image/png",1),A=h=>typeof h=="function",w=h=>h===void 0,C=(h,t={},e="http://www.w3.org/2000/svg")=>{const s=document.createElementNS(e,h);for(const i in t)s.setAttribute(i,t[i]);return s},P=(h,t,e)=>{const s=[];let i="";for(let o=0,n=t.length;o<n;o++)i+=t.charAt(o),h.measureText(i).width>e&&(s.push(i.substring(0,i.length-1)),i="",o--);return s.push(i),s},R=(h,t)=>{const e=C("svg",{xmlns:"http://www.w3.org/2000/svg"}),s=document.createElement("div");s.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),s.style.cssText=`
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  font: ${h.font};
  color: ${t.fontColor};
`,s.innerHTML=`<div class="rich-text-content">${t.content}</div>`,document.body.appendChild(s);const{offsetHeight:i,offsetWidth:o}=s.querySelector(".rich-text-content");document.body.removeChild(s);const n=t.richTextWidth||o||t.width,a=t.richTextHeight||i||t.height,r=C("foreignObject",{width:n.toString(),height:a.toString()});return r.appendChild(s),e.appendChild(r),{element:e,width:n,height:a}},$=h=>`data:image/svg+xml;charset=utf-8,${h.outerHTML.replace(/\n/g,"").replace(/\t/g,"").replace(/#/g,"%23")}`;class O{constructor(t={}){this.parentElement=document.body,this.props=t,this.options=Object.assign({width:300,height:300,rotate:45,translatePlacement:"middle",contentType:"text",content:"hello watermark-js-plus",textType:"fill",imageWidth:0,imageHeight:0,lineHeight:30,zIndex:1e4,backgroundPosition:"0 0, 0 0",backgroundRepeat:"repeat",fontSize:"20px",fontFamily:"sans-serif",fontStyle:"",fontVariant:"",fontColor:"#000",fontWeight:"normal",filter:"none",globalAlpha:.5,mode:"default",mutationObserve:!0,unique:!0,parent:"body",onSuccess:()=>{},onBeforeDestroy:()=>{},onDestroyed:()=>{}},t),this.changeParentElement(this.options.parent),this.initializeOptions()}static createCanvas(t,e){var o;const s=window.devicePixelRatio||1,i=document.createElement("canvas");return i.width=t*s,i.height=e*s,i.style.width=`${t}px`,i.style.height=`${e}px`,(o=i.getContext("2d"))==null||o.setTransform(s,0,0,s,0,0),i}changeOptions(t={}){Object.keys(t).forEach(e=>{var s;(s=this.options)!=null&&s[e]&&(this.options[e]=t[e])})}changeParentElement(t){if(typeof t=="string"){const e=document.querySelector(t);e&&(this.parentElement=e)}else this.parentElement=t}async create(){var o,n;if(!this.validateUnique()||!this.validateContent())return;const t=await this.draw(),e=D(t);this.watermarkDom=document.createElement("div");const s=document.createElement("div");this.watermarkDom.__WATERMARK__="watermark",this.watermarkDom.__WATERMARK__INSTANCE__=this;const i=this.checkParentElementType();this.watermarkDom.style.cssText=`
      z-index: ${this.options.zIndex};
      ${i==="custom"?"top: 0;bottom: 0;left: 0;right: 0;height: 100%;pointer-events: none;position: absolute":"position: relative"}
    `,s.style.cssText=`
      position: ${i==="root"?"fixed;":"absolute;"}
      z-index: ${this.options.zIndex};
      pointer-events: none;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background-image: url(${e});
      background-repeat: ${this.options.backgroundRepeat};
      background-size: ${this.options.width}px ${this.options.height}px;
      background-position: ${this.options.backgroundPosition};
      -webkit-print-color-adjust: exact;
    `,this.watermarkDom.append(s),this.parentElement.appendChild(this.watermarkDom),this.options.mutationObserve&&this.bindMutationObserve(),(n=(o=this.options).onSuccess)==null||n.call(o)}destroy(){var t,e,s,i,o,n,a;(e=(t=this.options).onBeforeDestroy)==null||e.call(t),(s=this.observer)==null||s.disconnect(),(i=this.parentObserve)==null||i.disconnect(),(o=this.watermarkDom)==null||o.remove(),(a=(n=this.options).onDestroyed)==null||a.call(n)}initializeOptions(){var o,n,a,r,c;(o=this.options)!=null&&o.rotate&&(this.options.rotate=(360-this.options.rotate%360)*(Math.PI/180));let t,e,s="middle",i="center";switch(this.options.translatePlacement){case"top":t=this.options.width/2,e=0,s="top";break;case"top-start":t=0,e=0,s="top",i="start";break;case"top-end":t=this.options.width,e=0,s="top",i="end";break;case"bottom":t=this.options.width/2,e=this.options.height,s="bottom";break;case"bottom-start":t=0,e=this.options.height,s="bottom",i="start";break;case"bottom-end":t=this.options.width,e=this.options.height,s="bottom",i="end";break;case"left":t=0,e=this.options.height/2,i="start";break;case"right":t=this.options.width,e=this.options.height/2,i="end";break;case"middle":t=this.options.width/2,e=this.options.height/2;break}w((n=this.props)==null?void 0:n.translateX)||w((a=this.props)==null?void 0:a.translateY)?(this.options.translateX=t,this.options.translateY=e):(s="top",i="left",this.defaultAdvancedStyleParams.x0=0,this.defaultAdvancedStyleParams.x1=this.options.textRowMaxWidth||this.options.width),w((r=this.props)==null?void 0:r.textBaseline)&&(this.options.textBaseline=s),w((c=this.props)==null?void 0:c.textAlign)&&(this.options.textAlign=i)}validateUnique(){let t=!0;return this.options.unique&&this.parentElement.childNodes.forEach(e=>{!t||Object.hasOwnProperty.call(e,"__WATERMARK__")&&(t=!1)}),t}validateContent(){switch(this.options.contentType){case"image":return Object.hasOwnProperty.call(this.options,"image");case"multi-line-text":case"rich-text":case"text":return this.options.content.length>0}return!1}draw(){const e=O.createCanvas(this.options.width,this.options.height).getContext("2d");if(e===null)throw new Error("get context error");return this.setStyle(e),e.translate(this.options.translateX,this.options.translateY),e.rotate(this.options.rotate),new Promise(s=>{switch(this.options.contentType){case"text":this.drawText(e,s);break;case"image":this.drawImage(e,s);break;case"multi-line-text":this.drawMultiLineText(e,s);break;case"rich-text":this.drawRichText(e,s);break}})}setStyle(t){var i;let e="fillStyle";this.options.textType==="stroke"&&(e="strokeStyle");let s=this.options.fontColor;if((i=this.options)!=null&&i.advancedStyle)switch(this.options.advancedStyle.type){case"linear":s=this.createLinearGradient(t);break;case"radial":s=this.createRadialGradient(t);break;case"conic":s=this.createConicGradient(t);break;case"pattern":s=this.createPattern(t);break}t[e]&&s&&(t[e]=s),t.font=`${this.options.fontStyle} ${this.options.fontVariant} ${this.options.fontWeight} ${this.options.fontSize} ${this.options.fontFamily}`,t.filter=this.options.filter,this.options.textAlign&&(t.textAlign=this.options.textAlign),this.options.textBaseline&&(t.textBaseline=this.options.textBaseline),t.globalAlpha=this.options.globalAlpha,this.options.shadowStyle&&(t.shadowBlur=this.options.shadowStyle.shadowBlur||0,t.shadowColor=this.options.shadowStyle.shadowColor||"#00000000",t.shadowOffsetX=this.options.shadowStyle.shadowOffsetX||0,t.shadowOffsetY=this.options.shadowStyle.shadowOffsetY||0),A(this.options.extraDrawFunc)&&this.options.extraDrawFunc(t)}createLinearGradient(t){var s,i,o,n,a,r,c,l,d,p,m,g,u,b,f;const e=t.createLinearGradient((o=(i=(s=this.options)==null?void 0:s.advancedStyle)==null?void 0:i.params)==null?void 0:o.x0,(r=(a=(n=this.options)==null?void 0:n.advancedStyle)==null?void 0:a.params)==null?void 0:r.y0,(d=(l=(c=this.options)==null?void 0:c.advancedStyle)==null?void 0:l.params)==null?void 0:d.x1,(g=(m=(p=this.options)==null?void 0:p.advancedStyle)==null?void 0:m.params)==null?void 0:g.y1);return(f=(b=(u=this.options)==null?void 0:u.advancedStyle)==null?void 0:b.colorStops)==null||f.forEach(y=>{e.addColorStop(y.offset,y.color)}),e}createConicGradient(t){var s,i,o,n,a,r,c,l,d,p,m,g;const e=t.createConicGradient((o=(i=(s=this.options)==null?void 0:s.advancedStyle)==null?void 0:i.params)==null?void 0:o.startAngle,(r=(a=(n=this.options)==null?void 0:n.advancedStyle)==null?void 0:a.params)==null?void 0:r.x,(d=(l=(c=this.options)==null?void 0:c.advancedStyle)==null?void 0:l.params)==null?void 0:d.y);return(g=(m=(p=this.options)==null?void 0:p.advancedStyle)==null?void 0:m.colorStops)==null||g.forEach(u=>{e.addColorStop(u.offset,u.color)}),e}createRadialGradient(t){var s,i,o,n,a,r,c,l,d,p,m,g,u,b,f,y,x,v,k,S,E;const e=t.createRadialGradient((o=(i=(s=this.options)==null?void 0:s.advancedStyle)==null?void 0:i.params)==null?void 0:o.x0,(r=(a=(n=this.options)==null?void 0:n.advancedStyle)==null?void 0:a.params)==null?void 0:r.y0,(d=(l=(c=this.options)==null?void 0:c.advancedStyle)==null?void 0:l.params)==null?void 0:d.r0,(g=(m=(p=this.options)==null?void 0:p.advancedStyle)==null?void 0:m.params)==null?void 0:g.x1,(f=(b=(u=this.options)==null?void 0:u.advancedStyle)==null?void 0:b.params)==null?void 0:f.y1,(v=(x=(y=this.options)==null?void 0:y.advancedStyle)==null?void 0:x.params)==null?void 0:v.r1);return(E=(S=(k=this.options)==null?void 0:k.advancedStyle)==null?void 0:S.colorStops)==null||E.forEach(T=>{e.addColorStop(T.offset,T.color)}),e}createPattern(t){var e,s,i,o,n,a;return t.createPattern((i=(s=(e=this.options)==null?void 0:e.advancedStyle)==null?void 0:s.params)==null?void 0:i.image,((a=(n=(o=this.options)==null?void 0:o.advancedStyle)==null?void 0:n.params)==null?void 0:a.repetition)||"")}setText(t,e){let s="fillText";this.options.textType==="stroke"&&(s="strokeText"),t[s]&&t[s](e.text,e.x,e.y,e.maxWidth)}drawText(t,e){this.setText(t,{text:this.options.content,x:0,y:0,maxWidth:this.options.textRowMaxWidth}),e(t.canvas)}drawImage(t,e){const s=new Image;s.setAttribute("crossOrigin","Anonymous"),s.src=this.options.image,s.onload=()=>{const{width:i,height:o}=this.getImageRect(s),n=this.getDrawImagePosition(i,o);t.drawImage(s,n.x,n.y,i,o),e(t.canvas)}}drawMultiLineText(t,e){const s=this.options.textRowMaxWidth||this.options.width,i=P(t,this.options.content,s);let o;switch(this.options.textBaseline){case"middle":o=(i.length-1)*this.options.lineHeight/2;break;case"bottom":case"alphabetic":case"ideographic":o=(i.length-1)*this.options.lineHeight;break;case"top":case"hanging":o=0;break}i.forEach((n,a)=>{this.setText(t,{text:n,x:0,y:this.options.lineHeight*a-o})}),e(t.canvas)}drawRichText(t,e){const s=R(t,this.options),i=new Image;i.width=s.width,i.height=s.height,i.src=$(s.element),i.onload=()=>{const o=this.getDrawImagePosition(i.width,i.height);t.drawImage(i,o.x,o.y,t.canvas.width,t.canvas.height),e(t.canvas)}}getImageRect(t){const e={width:this.options.imageWidth,height:this.options.imageHeight};switch(!0){case(e.width!==0&&e.height===0):e.height=e.width*t.height/t.width;break;case(e.width===0&&e.height!==0):e.width=e.height*t.width/t.height;break;case(e.width===0&&e.height===0):e.width=t.width,e.height=t.height;break}return e}getDrawImagePosition(t,e){var i,o;const s={x:-t/2,y:-e/2};switch(this.options.translatePlacement){case"top":s.x=-t/2,s.y=0;break;case"top-start":s.x=0,s.y=0;break;case"top-end":s.x=-t,s.y=0;break;case"bottom":s.x=-t/2,s.y=-e;break;case"bottom-start":s.x=0,s.y=-e;break;case"bottom-end":s.x=-t,s.y=-e;break;case"left":s.x=0,s.y=-e/2;break;case"right":s.x=-t,s.y=-e/2;break}return!w((i=this.props)==null?void 0:i.translateX)&&(s.x=0),!w((o=this.props)==null?void 0:o.translateY)&&(s.y=0),s}checkParentElementType(){return["html","body"].includes(this.parentElement.tagName.toLocaleLowerCase())?"root":"custom"}bindMutationObserve(){!this.watermarkDom||(this.observer=new MutationObserver(t=>{t.length>0&&(this.destroy(),this.create())}),this.observer.observe(this.watermarkDom,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.parentObserve=new MutationObserver(t=>{t.forEach(e=>{var s;((e==null?void 0:e.target)===this.watermarkDom||((s=e==null?void 0:e.removedNodes)==null?void 0:s[0])===this.watermarkDom)&&(this.destroy(),this.create())})}),this.parentObserve.observe(this.parentElement,{attributes:!0,childList:!0,subtree:!0,characterData:!0}))}}export{O as W,D as c,A as i};
