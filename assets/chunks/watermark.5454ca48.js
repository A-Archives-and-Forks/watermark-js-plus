const G=h=>h.toDataURL("image/png",1),V=h=>typeof h=="function",o=h=>h===void 0,$=(h,t={},a="http://www.w3.org/2000/svg")=>{const i=document.createElementNS(a,h);for(const e in t)i.setAttribute(e,t[e]);return i},_=(h,t,a)=>{const i=[];let e="";for(let n=0,r=t.length;n<r;n++)e+=t.charAt(n),h.measureText(e).width>a&&(i.push(e.substring(0,e.length-1)),e="",n--);return i.push(e),i},j=(h,t)=>{const a=$("svg",{xmlns:"http://www.w3.org/2000/svg"}),i=document.createElement("div");i.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),i.style.cssText=`
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  font: ${h.font};
  color: ${t.fontColor};
`,i.innerHTML=`<div class="rich-text-content">${t.content}</div>`,document.body.appendChild(i);const{offsetHeight:e,offsetWidth:n}=i.querySelector(".rich-text-content");document.body.removeChild(i);const r=t.richTextWidth||n||t.width,s=t.richTextHeight||e||t.height,d=$("foreignObject",{width:r.toString(),height:s.toString()});return d.appendChild(i),a.appendChild(d),{element:a,width:r,height:s}},B=h=>`data:image/svg+xml;charset=utf-8,${h.outerHTML.replace(/\n/g,"").replace(/\t/g,"").replace(/#/g,"%23")}`,l=(h,t)=>o(h)?t:h,I=(h,t=void 0,a=void 0)=>{const i=new Image;return i.setAttribute("crossOrigin","Anonymous"),!o(t)&&(i.width=t),!o(a)&&(i.height=a),i.src=h,new Promise(e=>{i.onload=()=>{e(i)}})},M={width:300,height:300,rotate:45,auxiliaryLine:!1,translatePlacement:"middle",contentType:"text",content:"hello watermark-js-plus",textType:"fill",imageWidth:0,imageHeight:0,lineHeight:30,zIndex:1e4,backgroundPosition:"0 0, 0 0",backgroundRepeat:"repeat",fontSize:"20px",fontFamily:"sans-serif",fontStyle:"",fontVariant:"",fontColor:"#000",fontWeight:"normal",filter:"none",globalAlpha:.5,mode:"default",mutationObserve:!0,unique:!0,parent:"body",onSuccess:()=>{},onBeforeDestroy:()=>{},onDestroyed:()=>{}},W=(h,t,a)=>{const i=h.getContext("2d");if(i===null)throw new Error("get context error");i.font=`${t.fontStyle} ${t.fontVariant} ${t.fontWeight} ${t.fontSize} ${t.fontFamily}`,i.filter=t.filter,t!=null&&t.rotate&&(t.rotate=(360-t.rotate%360)*(Math.PI/180)),o(a.textRowMaxWidth)&&(t.textRowMaxWidth=t.width);const e={image:{rect:{width:t.imageWidth,height:t.imageHeight},position:{x:0,y:0}},textLine:{data:[],yOffsetValue:0},advancedStyleParams:{linear:{x0:0,x1:0},radial:{x0:0,y0:0,r0:0,x1:0,y1:0,r1:0},conic:{x:0,y:0,startAngle:0},pattern:{}}};switch(t.contentType){case"text":e.textLine.data=[t.content];break;case"multi-line-text":e.textLine.data=_(i,t.content,t.textRowMaxWidth);break}let n=t.width/2,r=t.height/2,s="middle",d="center";switch(!o(a==null?void 0:a.translateX)&&!o(a==null?void 0:a.translateY)?(n=a==null?void 0:a.translateX,r=a==null?void 0:a.translateY,s="top",d="left"):(e.advancedStyleParams.linear.x0=-t.width/2,e.advancedStyleParams.linear.x1=t.width/2,e.advancedStyleParams.radial.r0=0,e.advancedStyleParams.radial.r1=t.width/2),a.translatePlacement){case"top":n=t.width/2,r=0,s="top",e.advancedStyleParams.linear.x0=-t.width/2,e.advancedStyleParams.linear.x1=t.width/2,e.advancedStyleParams.radial.y0=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.y1=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.y=e.textLine.data.length*t.lineHeight/2;break;case"top-start":n=0,r=0,s="top",d="start",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=t.width,e.advancedStyleParams.radial.x0=t.width/2,e.advancedStyleParams.radial.y0=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.x1=t.width/2,e.advancedStyleParams.radial.y1=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=t.width/2,e.advancedStyleParams.conic.y=e.textLine.data.length*t.lineHeight/2;break;case"top-end":n=t.width,r=0,s="top",d="end",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=-t.width,e.advancedStyleParams.radial.x0=-t.width/2,e.advancedStyleParams.radial.y0=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.x1=-t.width/2,e.advancedStyleParams.radial.y1=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=-t.width/2,e.advancedStyleParams.conic.y=e.textLine.data.length*t.lineHeight/2;break;case"bottom":n=t.width/2,r=t.height,s="bottom",e.advancedStyleParams.linear.x0=-t.width/2,e.advancedStyleParams.linear.x1=t.width/2,e.advancedStyleParams.radial.y0=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.y1=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=0,e.advancedStyleParams.conic.y=-e.textLine.data.length*t.lineHeight/2;break;case"bottom-start":n=0,r=t.height,s="bottom",d="start",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=t.width,e.advancedStyleParams.radial.x0=t.width/2,e.advancedStyleParams.radial.y0=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.x1=t.width/2,e.advancedStyleParams.radial.y1=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=t.width/2,e.advancedStyleParams.conic.y=-e.textLine.data.length*t.lineHeight/2;break;case"bottom-end":n=t.width,r=t.height,s="bottom",d="end",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=-t.width,e.advancedStyleParams.radial.x0=-t.width/2,e.advancedStyleParams.radial.y0=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.x1=-t.width/2,e.advancedStyleParams.radial.y1=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=-t.width/2,e.advancedStyleParams.conic.y=-e.textLine.data.length*t.lineHeight/2;break;case"left":n=0,r=t.height/2,d="start",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=t.width,e.advancedStyleParams.radial.x0=t.width/2,e.advancedStyleParams.radial.x1=t.width/2,e.advancedStyleParams.conic.x=t.width/2,e.advancedStyleParams.conic.y=0;break;case"right":n=t.width,r=t.height/2,d="end",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=-t.width,e.advancedStyleParams.radial.x0=-t.width/2,e.advancedStyleParams.radial.x1=-t.width/2,e.advancedStyleParams.conic.x=-t.width/2,e.advancedStyleParams.conic.y=0;break}if(t.translateX=n,t.translateY=r,o(a==null?void 0:a.textBaseline)&&(t.textBaseline=s),o(a==null?void 0:a.textAlign)&&(t.textAlign=d),t.contentType==="multi-line-text")switch(t.textBaseline){case"middle":e.textLine.yOffsetValue=(e.textLine.data.length-1)*t.lineHeight/2;break;case"bottom":case"alphabetic":case"ideographic":e.textLine.yOffsetValue=(e.textLine.data.length-1)*t.lineHeight;break;case"top":case"hanging":e.textLine.yOffsetValue=0;break}return e};class f{constructor(t={}){this.parentElement=document.body,this.props=t,this.options=Object.assign({},M,t),this.changeParentElement(this.options.parent),this.canvas=f.createCanvas(this.options.width,this.options.height),this.recommendOptions=W(this.canvas,this.options,this.props)}static createCanvas(t,a){var n;const i=window.devicePixelRatio||1,e=document.createElement("canvas");return e.width=t*i,e.height=a*i,e.style.width=`${t}px`,e.style.height=`${a}px`,(n=e.getContext("2d"))==null||n.setTransform(i,0,0,i,0,0),e}changeOptions(t={},a="overwrite"){this.initConfigData(t,a)}async create(){var e,n;if(!this.validateUnique()||!this.validateContent())return;await this.draw();const t=G(this.canvas);this.clearCanvas(),this.watermarkDom=document.createElement("div");const a=document.createElement("div");this.watermarkDom.__WATERMARK__="watermark",this.watermarkDom.__WATERMARK__INSTANCE__=this;const i=this.checkParentElementType();this.watermarkDom.style.cssText=`
      z-index: ${this.options.zIndex};
      ${i==="custom"?"top: 0;bottom: 0;left: 0;right: 0;height: 100%;pointer-events: none;position: absolute":"position: relative"}
    `,a.style.cssText=`
      position: ${i==="root"?"fixed;":"absolute;"}
      z-index: ${this.options.zIndex};
      pointer-events: none;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background-image: url(${t});
      background-repeat: ${this.options.backgroundRepeat};
      background-size: ${this.options.width}px ${this.options.height}px;
      background-position: ${this.options.backgroundPosition};
      -webkit-print-color-adjust: exact;
    `,this.watermarkDom.append(a),this.parentElement.appendChild(this.watermarkDom),this.options.mutationObserve&&this.bindMutationObserve(),(n=(e=this.options).onSuccess)==null||n.call(e)}destroy(){var t,a,i,e,n,r,s;(a=(t=this.options).onBeforeDestroy)==null||a.call(t),(i=this.observer)==null||i.disconnect(),(e=this.parentObserve)==null||e.disconnect(),(n=this.watermarkDom)==null||n.remove(),(s=(r=this.options).onDestroyed)==null||s.call(r)}initConfigData(t,a="overwrite"){this.props=t,a==="overwrite"?this.options=Object.assign({},M,t):Object.keys(t).forEach(i=>{this.options[i]=t[i]}),this.changeParentElement(this.options.parent),this.canvas=f.createCanvas(this.options.width,this.options.height),this.recommendOptions=W(this.canvas,this.options,this.props)}changeParentElement(t){if(typeof t=="string"){const a=document.querySelector(t);a&&(this.parentElement=a)}else this.parentElement=t}validateUnique(){let t=!0;return this.options.unique&&this.parentElement.childNodes.forEach(a=>{t&&Object.hasOwnProperty.call(a,"__WATERMARK__")&&(t=!1)}),t}validateContent(){switch(this.options.contentType){case"image":return Object.hasOwnProperty.call(this.options,"image");case"multi-line-text":case"rich-text":case"text":return this.options.content.length>0}return!1}draw(){const t=this.canvas.getContext("2d");if(t===null)throw new Error("get context error");return this.options.auxiliaryLine&&(t.beginPath(),t.rect(1,1,this.options.width,this.options.height),t.lineWidth=1,t.strokeStyle="#000",t.stroke(),t.closePath(),t.beginPath(),t.rect(this.options.translateX,this.options.translateY,1,1),t.lineWidth=1,t.strokeStyle="#f00",t.stroke(),t.closePath()),this.setStyle(t),t.save(),t.translate(this.options.translateX,this.options.translateY),t.rotate(this.options.rotate),new Promise(a=>{switch(this.options.contentType){case"text":this.drawText(t,a);break;case"image":this.drawImage(t,a);break;case"multi-line-text":this.drawMultiLineText(t,a);break;case"rich-text":this.drawRichText(t,a);break}})}setStyle(t){var e;let a="fillStyle";this.options.textType==="stroke"&&(a="strokeStyle");let i=this.options.fontColor;if((e=this.options)!=null&&e.advancedStyle)switch(this.options.advancedStyle.type){case"linear":i=this.createLinearGradient(t);break;case"radial":i=this.createRadialGradient(t);break;case"conic":i=this.createConicGradient(t);break;case"pattern":i=this.createPattern(t);break}t[a]&&i&&(t[a]=i),this.options.textAlign&&(t.textAlign=this.options.textAlign),this.options.textBaseline&&(t.textBaseline=this.options.textBaseline),t.globalAlpha=this.options.globalAlpha,this.options.shadowStyle&&(t.shadowBlur=l(this.options.shadowStyle.shadowBlur,0),t.shadowColor=l(this.options.shadowStyle.shadowColor,"#00000000"),t.shadowOffsetX=l(this.options.shadowStyle.shadowOffsetX,0),t.shadowOffsetY=l(this.options.shadowStyle.shadowOffsetY,0)),V(this.options.extraDrawFunc)&&this.options.extraDrawFunc(t)}createLinearGradient(t){var i,e,n,r,s,d,c,m,y,x,w,v,g,u,p;const a=t.createLinearGradient(l((n=(e=(i=this.options.advancedStyle)==null?void 0:i.params)==null?void 0:e.linear)==null?void 0:n.x0,this.recommendOptions.advancedStyleParams.linear.x0),l((d=(s=(r=this.options.advancedStyle)==null?void 0:r.params)==null?void 0:s.linear)==null?void 0:d.y0,0),l((y=(m=(c=this.options.advancedStyle)==null?void 0:c.params)==null?void 0:m.linear)==null?void 0:y.x1,this.recommendOptions.advancedStyleParams.linear.x1),l((v=(w=(x=this.options.advancedStyle)==null?void 0:x.params)==null?void 0:w.linear)==null?void 0:v.y1,0));return(p=(u=(g=this.options)==null?void 0:g.advancedStyle)==null?void 0:u.colorStops)==null||p.forEach(S=>{a.addColorStop(S.offset,S.color)}),a}createConicGradient(t){var i,e,n,r,s,d,c,m,y,x,w,v,g,u,p;const a=t.createConicGradient(l((r=(n=(e=(i=this.options)==null?void 0:i.advancedStyle)==null?void 0:e.params)==null?void 0:n.conic)==null?void 0:r.startAngle,0),l((m=(c=(d=(s=this.options)==null?void 0:s.advancedStyle)==null?void 0:d.params)==null?void 0:c.conic)==null?void 0:m.x,this.recommendOptions.advancedStyleParams.conic.x),l((v=(w=(x=(y=this.options)==null?void 0:y.advancedStyle)==null?void 0:x.params)==null?void 0:w.conic)==null?void 0:v.y,this.recommendOptions.advancedStyleParams.conic.y));return(p=(u=(g=this.options)==null?void 0:g.advancedStyle)==null?void 0:u.colorStops)==null||p.forEach(S=>{a.addColorStop(S.offset,S.color)}),a}createRadialGradient(t){var i,e,n,r,s,d,c,m,y,x,w,v,g,u,p,S,b,P,k,O,L,E,T,C,D,H,A;const a=t.createRadialGradient(l((r=(n=(e=(i=this.options)==null?void 0:i.advancedStyle)==null?void 0:e.params)==null?void 0:n.radial)==null?void 0:r.x0,this.recommendOptions.advancedStyleParams.radial.x0),l((m=(c=(d=(s=this.options)==null?void 0:s.advancedStyle)==null?void 0:d.params)==null?void 0:c.radial)==null?void 0:m.y0,this.recommendOptions.advancedStyleParams.radial.y0),l((v=(w=(x=(y=this.options)==null?void 0:y.advancedStyle)==null?void 0:x.params)==null?void 0:w.radial)==null?void 0:v.r0,this.recommendOptions.advancedStyleParams.radial.r0),l((S=(p=(u=(g=this.options)==null?void 0:g.advancedStyle)==null?void 0:u.params)==null?void 0:p.radial)==null?void 0:S.x1,this.recommendOptions.advancedStyleParams.radial.x1),l((O=(k=(P=(b=this.options)==null?void 0:b.advancedStyle)==null?void 0:P.params)==null?void 0:k.radial)==null?void 0:O.y1,this.recommendOptions.advancedStyleParams.radial.y1),l((C=(T=(E=(L=this.options)==null?void 0:L.advancedStyle)==null?void 0:E.params)==null?void 0:T.radial)==null?void 0:C.r1,this.recommendOptions.advancedStyleParams.radial.r1));return(A=(H=(D=this.options)==null?void 0:D.advancedStyle)==null?void 0:H.colorStops)==null||A.forEach(R=>{a.addColorStop(R.offset,R.color)}),a}createPattern(t){var a,i,e,n,r,s,d,c;return t.createPattern((n=(e=(i=(a=this.options)==null?void 0:a.advancedStyle)==null?void 0:i.params)==null?void 0:e.pattern)==null?void 0:n.image,((c=(d=(s=(r=this.options)==null?void 0:r.advancedStyle)==null?void 0:s.params)==null?void 0:d.pattern)==null?void 0:c.repetition)||"")}setText(t,a){let i="fillText";this.options.textType==="stroke"&&(i="strokeText"),t[i]&&t[i](a.text,a.x,a.y,a.maxWidth)}drawText(t,a){this.setText(t,{text:this.options.content,x:0,y:0,maxWidth:this.options.textRowMaxWidth||this.options.width}),a(t.canvas)}drawImage(t,a){I(this.options.image).then(i=>{const{width:e,height:n}=this.getImageRect(i),r=this.getDrawImagePosition(e,n);t.drawImage(i,r.x,r.y,e,n),a(t.canvas)})}drawMultiLineText(t,a){const i=this.recommendOptions.textLine.data,e=this.recommendOptions.textLine.yOffsetValue;i.forEach((n,r)=>{this.setText(t,{text:n,x:0,y:this.options.lineHeight*r-e})}),a(t.canvas)}drawRichText(t,a){const i=j(t,this.options);I(B(i.element),i.width,i.height).then(e=>{const n=this.getDrawImagePosition(e.width,e.height);t.drawImage(e,n.x,n.y,t.canvas.width,t.canvas.height),a(t.canvas)})}getImageRect(t){const a={width:this.options.imageWidth||0,height:this.options.imageHeight||0};switch(!0){case(a.width!==0&&a.height===0):a.height=a.width*t.height/t.width;break;case(a.width===0&&a.height!==0):a.width=a.height*t.width/t.height;break;case(a.width===0&&a.height===0):a.width=t.width,a.height=t.height;break}return a}getDrawImagePosition(t,a){var e,n;const i={x:-t/2,y:-a/2};switch(this.options.translatePlacement){case"top":i.x=-t/2,i.y=0;break;case"top-start":i.x=0,i.y=0;break;case"top-end":i.x=-t,i.y=0;break;case"bottom":i.x=-t/2,i.y=-a;break;case"bottom-start":i.x=0,i.y=-a;break;case"bottom-end":i.x=-t,i.y=-a;break;case"left":i.x=0,i.y=-a/2;break;case"right":i.x=-t,i.y=-a/2;break}return!o((e=this.props)==null?void 0:e.translateX)&&(i.x=0),!o((n=this.props)==null?void 0:n.translateY)&&(i.y=0),i}checkParentElementType(){return["html","body"].includes(this.parentElement.tagName.toLocaleLowerCase())?"root":"custom"}bindMutationObserve(){this.watermarkDom&&(this.observer=new MutationObserver(t=>{t.length>0&&(this.destroy(),this.create())}),this.observer.observe(this.watermarkDom,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.parentObserve=new MutationObserver(t=>{t.forEach(a=>{var i;((a==null?void 0:a.target)===this.watermarkDom||((i=a==null?void 0:a.removedNodes)==null?void 0:i[0])===this.watermarkDom)&&(this.destroy(),this.create())})}),this.parentObserve.observe(this.parentElement,{attributes:!0,childList:!0,subtree:!0,characterData:!0}))}clearCanvas(){const t=this.canvas.getContext("2d");if(t===null)throw new Error("get context error");t.restore(),t.clearRect(0,0,this.canvas.width,this.canvas.height)}}export{f as W,G as c,V as i,I as l};
