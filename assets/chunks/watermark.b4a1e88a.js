const u=s=>s.toDataURL("image/png",1),v=s=>typeof s=="function",c=(s,t={},e="http://www.w3.org/2000/svg")=>{const i=document.createElementNS(e,s);for(const n in t)i.setAttribute(n,t[n]);return i},m=(s,t,e)=>{const i=[];let n="";for(let o=0,a=t.length;o<a;o++)n+=t.charAt(o),s.measureText(n).width>e&&(i.push(n.substring(0,n.length-1)),n="",o--);return i.push(n),i},w=(s,t)=>{const e=c("svg",{xmlns:"http://www.w3.org/2000/svg"}),i=c("foreignObject",{width:t.width.toString(),height:t.height.toString()}),n=document.createElement("div");return n.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),n.style.cssText=`
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  font: ${s.font};
  color: ${t.fontColor};
  `,n.innerHTML=t.content,i.appendChild(n),e.appendChild(i),e},b=s=>`data:image/svg+xml;charset=utf-8,${s.outerHTML.replace(/\n/g,"").replace(/\t/g,"").replace(/#/g,"%23")}`;var r=(s=>(s.text="text",s.image="image",s.multiLineText="multi-line-text",s.richText="rich-text",s))(r||{}),l=(s=>(s.center="center",s.left="left",s.right="right",s))(l||{}),g=(s=>(s.top="top",s.bottom="bottom",s.middle="middle",s))(g||{}),p=(s=>(s.default="default",s.blind="blind",s))(p||{}),f=(s=>(s.canvas="canvas",s.html="html",s.svg="svg",s))(f||{});class d{constructor(t={}){var e;this.parentElement=document.body,this.options=Object.assign({width:300,height:300,rotate:45,contentType:r.text,content:"hello watermark-js-plus",imageWidth:0,imageHeight:0,lineHeight:30,zIndex:1e4,backgroundPosition:"0 0, 0 0",backgroundRepeat:"repeat",fontSize:20,fontFamily:"sans-serif",textAlign:l.center,textBaseline:g.middle,fontColor:"#000",globalAlpha:.5,fontWeight:"normal",mode:p.default,mutationObserve:!0,unique:!0,parent:"body",onSuccess:()=>{},onBeforeDestroy:()=>{},onDestroyed:()=>{}},t),(e=this.options)!=null&&e.rotate&&(this.options.rotate=(360-this.options.rotate%360)*(Math.PI/180)),this.changeParentElement(this.options.parent)}static createCanvas(t,e){var o;const i=window.devicePixelRatio||1,n=document.createElement("canvas");return n.width=t*i,n.height=e*i,n.style.width=`${t}px`,n.style.height=`${e}px`,(o=n.getContext("2d"))==null||o.setTransform(i,0,0,i,0,0),n}changeParentElement(t){if(typeof t=="string"){const e=document.querySelector(t);e&&(this.parentElement=e)}else this.parentElement=t}async create(){var o,a;if(!this.validateUnique()||!this.validateContent())return;const t=await this.draw(),e=u(t);this.watermarkDom=document.createElement("div");const i=document.createElement("div");this.watermarkDom.__WATERMARK__="watermark",this.watermarkDom.__WATERMARK__INSTANCE__=this;const n=this.checkParentElementType();this.watermarkDom.style.cssText=`
      z-index: ${this.options.zIndex};
      ${n==="custom"?"top: 0;bottom: 0;left: 0;right: 0;height: 100%;pointer-events: none;position: absolute":"position: relative"}
    `,i.style.cssText=`
      position: ${n==="root"?"fixed;":"absolute;"}
      z-index: ${this.options.zIndex};
      pointer-events: none;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background-image: url(${e});
      background-repeat: ${this.options.backgroundRepeat};
      background-size: ${this.options.width}px ${this.options.height}px;
      background-position: ${this.options.backgroundPosition};
      -webkit-print-color-adjust: exact;
    `,this.watermarkDom.append(i),this.parentElement.appendChild(this.watermarkDom),this.options.mutationObserve&&this.bindMutationObserve(),(a=(o=this.options).onSuccess)==null||a.call(o)}destroy(){var t,e,i,n,o,a,h;(e=(t=this.options).onBeforeDestroy)==null||e.call(t),(i=this.observer)==null||i.disconnect(),(n=this.parentObserve)==null||n.disconnect(),(o=this.watermarkDom)==null||o.remove(),(h=(a=this.options).onDestroyed)==null||h.call(a)}validateUnique(){let t=!0;return this.options.unique&&this.parentElement.childNodes.forEach(e=>{!t||Object.hasOwnProperty.call(e,"__WATERMARK__")&&(t=!1)}),t}validateContent(){switch(this.options.contentType){case r.image:return Object.hasOwnProperty.call(this.options,"image");case r.multiLineText:case r.richText:case r.text:return this.options.content.length>0}return!1}draw(){const e=d.createCanvas(this.options.width,this.options.height).getContext("2d");if(e===null)throw new Error("get context error");return e.font=`${this.options.fontWeight} ${this.options.fontSize}px ${this.options.fontFamily}`,e.textAlign=this.options.textAlign,e.textBaseline=this.options.textBaseline,e.fillStyle=this.options.fontColor,e.globalAlpha=this.options.globalAlpha,new Promise(i=>{switch(this.options.contentType){case r.text:this.drawText(e,i);break;case r.image:this.drawImage(e,i);break;case r.multiLineText:this.drawMultiLineText(e,i);break;case r.richText:this.drawRichText(e,i);break}})}drawText(t,e){t.translate(this.options.width/2,this.options.height/2),t.rotate(this.options.rotate),t.fillText(this.options.content,0,0),e(t.canvas)}drawImage(t,e){const i=new Image;i.setAttribute("crossOrigin","Anonymous"),i.src=this.options.image,i.onload=()=>{t.translate(this.options.width/2,this.options.height/2),t.rotate(this.options.rotate);const{width:n,height:o}=this.getImageRect(i);t.drawImage(i,0-n/2,0-o/2,n,o),e(t.canvas)}}drawMultiLineText(t,e){const i=m(t,this.options.content,this.options.width);t.translate(this.options.width/2,this.options.height/2),t.rotate(this.options.rotate);const n=(i.length-1)*this.options.lineHeight/2;i.forEach((o,a)=>{t.fillText(o,0,this.options.lineHeight*a-n)}),e(t.canvas)}drawRichText(t,e){const i=new Image;i.width=this.options.width,i.height=this.options.height;const n=w(t,this.options);i.src=b(n),i.onload=()=>{t.translate(this.options.width/2,this.options.height/2),t.rotate(this.options.rotate),t.drawImage(i,-this.options.width/2,-this.options.height/2,t.canvas.width,t.canvas.height),e(t.canvas)}}getImageRect(t){const e={width:this.options.imageWidth,height:this.options.imageHeight};switch(!0){case(e.width!==0&&e.height===0):e.height=e.width*t.height/t.width;break;case(e.width===0&&e.height!==0):e.width=e.height*t.width/t.height;break;case(e.width===0&&e.height===0):e.width=t.width,e.height=t.height;break}return e}checkParentElementType(){return["html","body"].includes(this.parentElement.tagName.toLocaleLowerCase())?"root":"custom"}bindMutationObserve(){!this.watermarkDom||(this.observer=new MutationObserver(t=>{t.length>0&&(this.destroy(),this.create())}),this.observer.observe(this.watermarkDom,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.parentObserve=new MutationObserver(t=>{t.forEach(e=>{var i;((e==null?void 0:e.target)===this.watermarkDom||((i=e==null?void 0:e.removedNodes)==null?void 0:i[0])===this.watermarkDom)&&(this.destroy(),this.create())})}),this.parentObserve.observe(this.parentElement,{attributes:!0,childList:!0,subtree:!0,characterData:!0}))}}export{p as C,f as D,d as W,u as c,v as i};
